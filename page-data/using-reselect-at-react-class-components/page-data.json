{"componentChunkName":"component---src-templates-blog-post-jsx","path":"/using-reselect-at-react-class-components/","result":{"data":{"site":{"siteMetadata":{"title":"Martin Schnürer","author":"Martin Schnürer"}},"markdownRemark":{"id":"ee1d8e18-1e4e-56b5-96c7-8394692c3d86","excerpt":"Today at the work, I had a little trouble with refactoring our class components. The problem was our react frontend application was unresponsive and lags on…","html":"<p>Today at the work, I had a little trouble with refactoring our class components. The problem was our react frontend application was unresponsive and lags on user input. Too many key-downs and an input started to filling a few seconds later after user stopped typing. Horrible experience - as for programmer, as for user. I tracked the app with Chrome DevTools. Some of our components were rerendered, but the data change was not intended for these components - so they shouldn’t be rerendered right ? Rerenders happen, when store changes - and store changes when we update input (and we have a lot of inputs). </p>\n<p>Our main view looks something like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre style=\"counter-reset: linenumber 0\" class=\"language-jsx line-numbers\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Panel</span> exntends PureComponent <span class=\"token punctuation\">{</span>\n   \n   <span class=\"token function-variable function\">compute</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">item<span class=\"token punctuation\">,</span> counter<span class=\"token punctuation\">,</span> anotherCounter</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span> heavyFunction <span class=\"token operator\">...</span>\n   <span class=\"token punctuation\">}</span>\n\n   <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      \n      <span class=\"token keyword\">const</span> counter1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> counter2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      \n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n         <span class=\"token operator\">...</span> a lot <span class=\"token keyword\">of</span> computing\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">HeavySection</span></span> \n               <span class=\"token attr-name\">onCreate</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">item</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">compute</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">,</span> counter1<span class=\"token punctuation\">,</span> counter2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\n            <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n         </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code><span aria-hidden=\"true\" class=\"line-numbers-rows\" style=\"white-space: normal; width: auto; left: 0;\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></pre></div>\n<p>On line 18 we passed anonymous function to the component <code class=\"language-text\">HeavySection</code> …well,  is this a problem? In most cases not. In my case\nit was a problem because rendering of the component last a few hundred milliseconds. The component <code class=\"language-text\">Panel</code> was connected to the <em>redux</em> store. The whole app view is heavy occupied with controlled inputs subscribed to the store (onChange). When a value in the inputs has changed, the store will update with the new immutable value. So the extending from PureComponent however, doesn’t help as soon as reference check fail at the store variable (connected to the component). There is a minimal chance of optimizing the parent panel. The next problem however, is that in render method we have HeavySection component with rerender time in a few hundred milliseconds. For the simplicity, we have only one HeavyComponent, but we could end up with 10-50 with HeavyComponents. Let’s say, the HeavyComponent is extended from PureComponent as well. Again, it doesn’t help as soon as it receives the prop <code class=\"language-text\">onCreate</code> with new anonymous function - every rerender creates new anonymous function again - therefore new reference is created and shallow check at PureComponent (shouldComponentUpdate) will fail!</p>\n<h2>What can we do with that ?</h2>\n<p>There is 95% chance you can extract that anonymous function and move to the arrow method like this:</p>\n<h3>Before:</h3>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Component</span> ext<span class=\"token operator\">...</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Heavy</span></span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">arg</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span>\n      <span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>After</h3>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Component</span> ext<span class=\"token operator\">...</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token function-variable function\">onClickHandler</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">arg</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token operator\">...</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n   \n   <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Heavy</span></span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>onClickHandler<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span>\n      <span class=\"token punctuation\">)</span>\n   <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Cool! Now the reference of the method is always rock static and will not change, therefore your Heavy component will not be rerendered. Job done.</p>\n<p>What about our case, remember ?</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Panel</span> exntends PureComponent <span class=\"token punctuation\">{</span>\n   \n   <span class=\"token function-variable function\">compute</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">item<span class=\"token punctuation\">,</span> counter<span class=\"token punctuation\">,</span> anotherCounter</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span> heavyFunction\n   <span class=\"token punctuation\">}</span>\n\n   <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      \n      <span class=\"token keyword\">const</span> counter1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> counter2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      \n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n         <span class=\"token operator\">...</span> a lot <span class=\"token keyword\">of</span> computing\n         <span class=\"token operator\">...</span> setting counters <span class=\"token operator\">...</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">HeavySection</span></span> \n               <span class=\"token attr-name\">onCreate</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">item</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">compute</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">,</span> counter1<span class=\"token punctuation\">,</span> counter2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\n            <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n         </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Do you remember how I told you 95% of anonymous functions in a prop fields are rewritable ?\nUnfortunatelly, this is the case of these last 5%.</p>\n<p>You see that our HeavySection executing onCreate function with one argument <code class=\"language-text\">item</code>. This function calls another\nfunction <code class=\"language-text\">this.compute</code> with arguments <em>item</em>, <em>counter1</em>, <em>counter2</em>. So we can’t extract the function to the method, because this called function depends on the variables computed inside render method. For the sake of simplicity and saved time - I will tell you that I am not merely happy with “heavy computiation” inside a render method - you always should be prepared and cautious when something like this start to happen. Render method should always do, what it is called for - to Render! In a best optimized world, we would move the computation outside of the render method and outside of the component - to the store actions or reducer, or in the component method once a time and then save values in the component <em>state</em>. But now, the computing mechanism inside the render method is not readable and uses a lot of props on the computation. So we’ve got a little spaghetti here and it would not be efficient spending a few hours of removing bad looking and unreadable code outside of the render method. </p>\n<p>Our purpose was to fasten the application and get rid of eventual lags at typing. We solve that by passing not-changing values to the props of our components.</p>\n<p>For clarification see why we can’t extract to the method:</p>\n<h2>Before</h2>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Panel</span> exntends PureComponent <span class=\"token punctuation\">{</span>\n   \n   <span class=\"token function-variable function\">compute</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">item<span class=\"token punctuation\">,</span> counter<span class=\"token punctuation\">,</span> anotherCounter</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span> heavyFunction\n   <span class=\"token punctuation\">}</span>\n\n   <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      \n      <span class=\"token keyword\">const</span> counter1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> counter2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      \n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n         <span class=\"token operator\">...</span> a lot <span class=\"token keyword\">of</span> computing\n         <span class=\"token operator\">...</span> setting counters <span class=\"token operator\">...</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">HeavySection</span></span> \n               <span class=\"token attr-name\">onCreate</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">item</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">compute</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">,</span> counter1<span class=\"token punctuation\">,</span> counter2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\n            <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n         </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2> After?</h2>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Panel</span> exntends PureComponent <span class=\"token punctuation\">{</span>\n   \n   <span class=\"token function-variable function\">compute</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">item<span class=\"token punctuation\">,</span> counter<span class=\"token punctuation\">,</span> anotherCounter</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span> heavyFunction\n   <span class=\"token punctuation\">}</span>\n\n   <span class=\"token comment\">// We don't have counter1 and counter2 variables because they are computed inside render method</span>\n   <span class=\"token function-variable function\">extractFunction</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">item</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">compute</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">,</span> counter1 <span class=\"token operator\">?</span><span class=\"token operator\">?</span><span class=\"token operator\">?</span><span class=\"token punctuation\">,</span> counter2 <span class=\"token operator\">?</span><span class=\"token operator\">?</span><span class=\"token operator\">?</span><span class=\"token punctuation\">)</span>\n\n   <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      \n      <span class=\"token keyword\">const</span> counter1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> counter2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      \n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n         <span class=\"token operator\">...</span> a lot <span class=\"token keyword\">of</span> computing\n         <span class=\"token operator\">...</span> setting counters <span class=\"token operator\">...</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">HeavySection</span></span> \n               <span class=\"token attr-name\">onCreate</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>extractFunction<span class=\"token punctuation\">}</span></span>\n            <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n         </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>As you can see, we can’t do that. We need the <em>counter1</em> and <em>counter2</em> variable coming from render method.</p>\n<h1>Solution to the problem</h1>\n<p>Have you heard about <em>reselect</em> package? I had this npm package in my mind, heard about it but never used it on the frequently basis. Never had to.</p>\n<p>You can find functions as <em>createSelector</em>, <em>defaultMemoize</em>,<em>createSelectorCreator</em> and <em>createStructureCreator</em>.\nFor more information see <a href=\"https://github.com/reduxjs/reselect\" target=\"_blank\" rel=\"nofollow\">link</a>.</p>\n<p>DefaultMemoize solves this problem. I will explain you how.\nHere you can see the definition of the <em>defaultMemoize</em> function.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">defaultMemoize</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">func<span class=\"token punctuation\">,</span> equalityCheck <span class=\"token operator\">=</span> defaultEqualityCheck</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>At first, I was a little bit confused how I have to use this function. Both arguments <em>func</em> and <em>equalityCheck</em> are functions. Second function is optional and if you don’t provide the function <em>defaultEqualityCheck</em> will be placed as default equalityCheck function. <em>defaultEqualityCheck</em> function looks as simple as:</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">defaultEqualityCheck</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">currentValue<span class=\"token punctuation\">,</span> previousValue</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n   <span class=\"token keyword\">return</span> currentValue <span class=\"token operator\">===</span> previousValue<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Then you call defaultMemoize like this.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> compute <span class=\"token operator\">=</span> <span class=\"token function\">defaultMemoize</span><span class=\"token punctuation\">(</span>fn<span class=\"token punctuation\">,</span> comparator<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>When you call defaultMemoize, it returns you another function. When you call this returned function, it decides whether return cached value or compute new value. How? By comparator function passed as second argument to the <em>defaultMemoize</em>. By calling the returned function from defaultMemoize, it always returns you a value - cached or computed - faster or slower. And how the value computed is based on <em>fn</em> function (first argument of the <em>defaultMemoize</em> function). Comparator function is called whenever you call <code class=\"language-text\">compute</code> function (returned by defaultMemoize) - if comparator returns true - cache value will be immediately returned. If it returns false, it recomputes the first argument function <code class=\"language-text\">fn</code> again.</p>\n<h2>Example</h2>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> obj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n   arr<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n   hash<span class=\"token punctuation\">:</span> <span class=\"token string\">\"efdk3j12b\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> computeSum <span class=\"token operator\">=</span> <span class=\"token function\">defaultMemoize</span><span class=\"token punctuation\">(</span>\n   <span class=\"token parameter\">obj</span> <span class=\"token operator\">=></span> obj<span class=\"token punctuation\">.</span><span class=\"token function\">reduce</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">acc<span class=\"token punctuation\">,</span> val</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> acc <span class=\"token operator\">+</span> val<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n   <span class=\"token punctuation\">(</span><span class=\"token parameter\">current<span class=\"token punctuation\">,</span> previous</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> current<span class=\"token punctuation\">.</span>hash <span class=\"token operator\">===</span> previous<span class=\"token punctuation\">.</span>hash<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// expensive first time computation</span>\n<span class=\"token keyword\">const</span> firstSum <span class=\"token operator\">=</span> <span class=\"token function\">computeSum</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// see, it has total same values as obj</span>\n<span class=\"token keyword\">const</span> newSameObj <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n   arr<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span><span class=\"token number\">4</span><span class=\"token punctuation\">,</span><span class=\"token number\">5</span><span class=\"token punctuation\">,</span><span class=\"token number\">6</span><span class=\"token punctuation\">,</span><span class=\"token number\">7</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n   hash<span class=\"token punctuation\">:</span> <span class=\"token string\">\"efdk3j12b\"</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// compute second time -> cheap, </span>\n<span class=\"token comment\">// comparator will be true, returned cache</span>\n<span class=\"token keyword\">const</span> secondSum <span class=\"token operator\">=</span> <span class=\"token function\">computeSum</span><span class=\"token punctuation\">(</span>newSameObj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\nfirstSum <span class=\"token operator\">===</span> secondSum <span class=\"token comment\">// true</span></code></pre></div>\n<p>Notes: In this example is object <em>obj</em> which is immutable and for some reason he always recreates - it’s values are same\nbut the reference is always changing. It has <em>arr</em> attribute and <em>hash</em> attribute. We know, that hash is the hash of the array and we want to recompute the sum only if the hash has changed. The memoize function describes how it is done.</p>\n<h2>Solve anonymous function problem</h2>\n<h3>Before</h3>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Panel</span> exntends PureComponent <span class=\"token punctuation\">{</span>\n   \n   <span class=\"token function-variable function\">compute</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">item<span class=\"token punctuation\">,</span> counter<span class=\"token punctuation\">,</span> anotherCounter</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span> heavyFunction\n   <span class=\"token punctuation\">}</span>\n\n   <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      \n      <span class=\"token keyword\">const</span> counter1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> counter2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      \n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n         <span class=\"token operator\">...</span> a lot <span class=\"token keyword\">of</span> computing\n         <span class=\"token operator\">...</span> setting counters <span class=\"token operator\">...</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">HeavySection</span></span> \n               <span class=\"token attr-name\">onCreate</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">item</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">compute</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">,</span> counter1<span class=\"token punctuation\">,</span> counter2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\n            <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n         </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3>After</h3>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Panel</span> exntends PureComponent <span class=\"token punctuation\">{</span>\n   \n   <span class=\"token function-variable function\">compute</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">item<span class=\"token punctuation\">,</span> counter<span class=\"token punctuation\">,</span> anotherCounter</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token operator\">...</span> heavyFunction\n   <span class=\"token punctuation\">}</span>\n\n   createHandlerMemo <span class=\"token operator\">=</span> <span class=\"token function\">defaultMemoize</span><span class=\"token punctuation\">(</span>\n      <span class=\"token parameter\">obj</span> <span class=\"token operator\">=></span> <span class=\"token parameter\">item</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">compute</span><span class=\"token punctuation\">(</span>item<span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">.</span>counter1<span class=\"token punctuation\">,</span> obj<span class=\"token punctuation\">.</span>counter2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">(</span><span class=\"token parameter\">current<span class=\"token punctuation\">,</span> prev</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> \n         _<span class=\"token punctuation\">.</span><span class=\"token function\">isEqual</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">.</span>counter1<span class=\"token punctuation\">,</span> prev<span class=\"token punctuation\">.</span>counter1<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span>\n         _<span class=\"token punctuation\">.</span><span class=\"token function\">isEqual</span><span class=\"token punctuation\">(</span>current<span class=\"token punctuation\">.</span>counter2<span class=\"token punctuation\">,</span> prev<span class=\"token punctuation\">.</span>counter2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n   <span class=\"token punctuation\">)</span>\n\n   <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      \n      <span class=\"token keyword\">const</span> counter1 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> counter2 <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n      \n      <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token operator\">...</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n         <span class=\"token operator\">...</span> a lot <span class=\"token keyword\">of</span> computing\n         <span class=\"token operator\">...</span> setting counters <span class=\"token operator\">...</span>\n      <span class=\"token punctuation\">}</span>\n\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n         <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n            </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">HeavySection</span></span> \n               <span class=\"token attr-name\">onCreate</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">createHandlerMemo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>counter1<span class=\"token punctuation\">,</span> counter2<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\n            <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n         </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n   <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>We created memoizedSelector inside component as the method. As the first argument (selector) says, it computes out function which will be passed to the component <em>HeavySection</em>. In the comparator, we compare both counters, if they are unchanged - then return previous cached function with the same reference! The HeavySection will not be rendered again and our app is going to be fast!</p>\n<p>I have done this today at work - replaced some anonymous functions with memoized selectors and got our app to run significantly faster.</p>\n<p>As you may know, the new version of the React uses hooks and one of the hooks is <em>useMemo</em>. Unfortunatelly, you can use <em>useMemo</em> only in functional components. However, you can use <em>defaultMemoize</em> inside your Class Components. Yay!</p>\n<p>Thanks for reading! </p>\n<h2>Appendix</h2>\n<p>I described optimization of the component rerendering on every change of “store”. In our app, due to the age of the project and old technologies used, we had two stores in our app - old store+dispatcher and redux store. We gradually and slowly rewriting functionality to the new redux store and planning to get rid of old store+dispatcher thing. This old store is somehow injecting the values to the components through router and routes. We injecting the store values to the route components by cloning these routes (React.cloneChildren) and passing the new props into them.</p>\n<p>This is the reason why I didn’t talk about <em>connect</em> function at all which is part of the <em>react-redux</em> npm package. This is the high-order component injecting store state into wrapped component. The advantage is I can specify which component gets the store and the second advantage is you can choose which state variables to inject into component. And also third one - you can make optimization on the <em>connect</em> level and prevent also rerendering of wrapped component - which was not unfortunatelly our case at the work - because we didn’t have any other option, but to work with the old approach of injecting props into component.</p>\n<p>If you are using redux, connect and mapStateToProps - I encourage you to use reselect mostly in your mapStateToProps function. </p>\n<blockquote>\n<p>Premature optimization is the root of all evil. Donald Knuth</p>\n</blockquote>\n<p>If you are in hurry and your wrapped component is not big - I understand you and therefore recommend to omit the reselect approach in this case and instead choose simple approach like pictured below. If your rerender doesn’t slow your app - it doesn’t matter for now and you can easily refactor in the future.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">mapStateToProps</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">state</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n   foo<span class=\"token punctuation\">:</span> state<span class=\"token punctuation\">.</span>foo\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">default</span> <span class=\"token function\">connect</span><span class=\"token punctuation\">(</span>mapStateToProps<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span>ChildComponent<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>","frontmatter":{"title":"Using Reselect at React Class Components","date":"March 27, 2019","categories":["programming"]}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/using-reselect-at-react-class-components/","previous":{"excerpt":"In \npart one\nI showed you how to create a simple way to track your expenses.  In this part I am going to show you how you can make some sexi…","fields":{"slug":"/creating-statistics-from-your-expenses-data/"},"frontmatter":{"date":"March 08, 2019","title":"How to Make Useful Expense Charts In Google Sheets","publish":null,"categories":["programming","personal"],"tags":["statistic","excel","technology","finance","expense","money"]}},"next":{"excerpt":"Let me share with you the list of what I don’t know yet in 2019. Life Flat tire - If I had any, my dad would repair. Always looked at it…","fields":{"slug":"/my-list-of-dont-knows/"},"frontmatter":{"date":"March 28, 2019","title":"My don't know list for 2019","publish":true,"categories":["personal"],"tags":["life","me"]}}}}}